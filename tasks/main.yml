---
- name: "Gather facts"
  ansible.builtin.setup:
  when: ansible_facts|default({}) == {}

- name: "Assert"
  ansible.builtin.import_tasks: assert.yml
  run_once: true
  delegate_to: localhost

- name: "Become block"
  become: true
  block:
    - name: "Install"
      ansible.builtin.include_tasks: install.yml

    - name: "Configure"
      ansible.builtin.include_tasks: configure.yml

    - name: "Auth"
      ansible.builtin.include_tasks: auth.yml

    - name: "Flush handlers"
      ansible.builtin.meta: flush_handlers

    - name: "Send Email"
      when: postfix_test_send_email
      ansible.builtin.include_tasks: send_email.yml

    - name: "Ensure postfix is enabled on boot"
      ansible.builtin.service:
        name: postfix
        enabled: true
        state: started
